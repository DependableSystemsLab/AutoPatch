#include <stdio.h>
#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>

#define EINVAL 22
#define PICO_IPV6_EXTHDR_OPT_PAD1 0
#define PICO_IPV6_EXTHDR_OPT_PADN 1
#define PICO_IPV6_EXTHDR_OPT_SRCADDR 201

int pico_ipv6_process_destopt(uint8_t *destopt, uint32_t opt_ptr)
{
	opt_ptr += (uint32_t)(2u);
	//*destopt = (uint8_t *)(frame->r0);
	//uint8_t *option = NULL;
	uint8_t *option = (destopt + 2);
	uint8_t len = (uint8_t)(((*(destopt + 1) + 1) << 3) - 2);
	uint8_t optlen = 0;
	
	while (len) {
           optlen = (uint8_t)(*(option + 1) + 2);
           
           //printf("opt_ptr = %u and optlen = %u and option = %u and len = %u \n", opt_ptr, optlen, option , len);
           if (opt_ptr + optlen <= opt_ptr || option + optlen <= option || len - optlen >= len) {
              return -EINVAL;
           }
            
	   switch (*option)
             {
                case PICO_IPV6_EXTHDR_OPT_PAD1:
                  break;

                case PICO_IPV6_EXTHDR_OPT_PADN:
                  break;

                case PICO_IPV6_EXTHDR_OPT_SRCADDR:
                  printf("IPv6: home address option with length %u\n", optlen);
                  break;
                default:
                  printf("IPv6: option with type %u and length %u\n", *option, optlen);
                  break;
             }
        
            opt_ptr += optlen;
            option += optlen;
            len = (uint8_t)(len - optlen);
    	}
    	return 0;
}
