#include <stdio.h>
#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>

#define MQTT_MAX_LENGTH_BYTES 4
#define EINVAL 22
#define MQTT_MAX_PAYLOAD_SIZE 0x0FFFFFFF
#define MQTT_LENGTH_VALUE_MASK 0x7F
#define MQTT_LENGTH_SHIFT 7
#define MQTT_LENGTH_CONTINUATION_BIT 0x80

struct buf_ctx {
    unsigned char *cur;
    unsigned char *end;
};

int packet_length_decode(struct buf_ctx *buf, uint32_t length)
{
	uint8_t shift = 0U;
	uint8_t bytes = 0U;
		
	length = 0U;
	do {
		if (bytes >= MQTT_MAX_LENGTH_BYTES) {
			return -EINVAL;
		}

		//if (buf->cur >= buf->end) {
		//	return -EAGAIN;
		//}
		length += ((uint32_t)*(buf->cur) & MQTT_LENGTH_VALUE_MASK)
								<< shift;
		shift += MQTT_LENGTH_SHIFT;
		bytes++;
	} while ((*(buf->cur++) & MQTT_LENGTH_CONTINUATION_BIT) != 0U);

	if (length > MQTT_MAX_PAYLOAD_SIZE) {
		return -EINVAL;
	}

	//MQTT_TRC("length:0x%08x", *length);

	return 0;
}
